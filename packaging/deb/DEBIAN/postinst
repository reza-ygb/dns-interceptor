#!/bin/bash
set -e
APP_DIR="/opt/dns-interceptor"
VENV_DIR="$APP_DIR/venv"

# Create app dir
mkdir -p "$APP_DIR"

# Copy files if not present (actual files will be placed by dpkg)
chmod +x "$APP_DIR/dns_interceptor.py" || true

# Create venv and install deps
if [[ ! -d "$VENV_DIR" ]]; then
  python3 -m venv "$VENV_DIR"
fi
"$VENV_DIR/bin/python" -m pip install --upgrade pip
if [[ -f "$APP_DIR/requirements.txt" ]]; then
  "$VENV_DIR/bin/pip" install -r "$APP_DIR/requirements.txt"
else
  "$VENV_DIR/bin/pip" install scapy>=2.5.0
fi

# Ensure wrapper is executable
chmod 755 /usr/bin/dns-interceptor || true

# Update desktop database (optional)
update-desktop-database >/dev/null 2>&1 || true

exit 0
